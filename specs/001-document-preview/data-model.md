# Data Model: Document Preview & Refinement

## Entities

### DocumentArtifact
- **Identity**: `documentId` (string path or UUID) unique per artifact
- **Fields**: `type` (enum: task/spec/plan/research/dataModel/api/quickstart), `title`, `owner`, `version`, `updatedAt`, `renderStandard` (e.g., markdown, mermaid, c4), `sections[]`, `forms[]` metadata
- **Relationships**: Owns multiple `DiagramBlock` and `FormField` definitions; referenced by `PreviewSession` and `RefinementRequest`
- **Validation**: renderStandard must match configured parser; sections must include anchor ids for intra-preview navigation
- **Lifecycle**: Created/updated elsewhere in SpecKit; this feature consumes read-only snapshots except for structured form submissions routed via existing pipelines

### PreviewSession
- **Identity**: `sessionId` (random UUID) per opened preview
- **Fields**: `documentId`, `openedAt`, `userId`, `scrollPosition`, `activeSection`, `pendingFormDraft` (serialized deltas), `diagnostics[]`
- **Relationships**: References one `DocumentArtifact`; emits `RefinementRequest` and `FormSubmission` events
- **Validation**: session expires when VS Code tab closes or 30 minutes of inactivity; pending drafts cleared after user reloads or submits
- **State transitions**: `loading → interactive → dirty (has draft) → submitted/closed`; concurrent update warning triggers `stale` flag until user reloads

### DiagramBlock
- **Identity**: `diagramId` (hash of section + index)
- **Fields**: `language` (mermaid/c4/plantuml), `rawSource`, `renderStatus`, `lastRenderedAt`
- **Relationships**: Child of `DocumentArtifact`; consumed by webview renderer pipeline
- **Validation**: `language` must map to supported renderer; `rawSource` limited to 100 KB to preserve performance

### FormField
- **Identity**: `fieldId` (section anchor + slug)
- **Fields**: `label`, `type` (checkbox/dropdown/text/multiselect), `options[]`, `required`, `value`, `validationRules`
- **Relationships**: Belongs to `DocumentArtifact`; `PreviewSession` copies definitions into local store at load
- **Validation**: Required fields must be satisfied before submission; dropdown selections must match provided options

### RefinementRequest
- **Identity**: `requestId` (generated by downstream refinement service)
- **Fields**: `documentId`, `documentType`, `documentVersion`, `reporterId`, `sectionRef`, `issueType` (missing detail/incorrect info/missing asset/other), `description`, `submittedAt`, `status`
- **Relationships**: Created from `PreviewSession` refine CTA; stored in existing refinement workflow
- **Validation**: `description` minimum 20 characters; `sectionRef` optional but, if provided, must match valid section anchor; references existing `DocumentArtifact`
- **State transitions**: `queued → in-progress → completed`; status updates reflected back into preview when available

## Derived Events
- **FormSubmission**: `{sessionId, documentId, fieldId, value, validationState}` used to persist structured input without editing Markdown body
- **PreviewWarning**: `{sessionId, documentId, reason (unsupportedSyntax|stale|permission)}` drives banner/CTA logic
