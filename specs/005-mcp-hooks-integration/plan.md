# Implementation Plan: MCP Server Integration for Hooks

**Branch**: `005-mcp-hooks-integration` | **Date**: December 5, 2025 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/005-mcp-hooks-integration/spec.md`

## Summary

Enable the Hooks module to discover and integrate with MCP (Model Context Protocol) servers configured in GitHub Copilot, allowing users to select MCP actions as hook actions and execute them when hooks are triggered. The system will automatically map parameters by name, enforce timeout controls (30s), manage concurrency (pool of 5), and gracefully handle MCP server unavailability.

## Technical Context

**Language/Version**: TypeScript 5.x (VS Code Extension)  
**Primary Dependencies**: VS Code Extension API, existing Hooks module, GitHub Copilot MCP integration  
**Storage**: VS Code workspace state (existing hook storage mechanism)  
**Testing**: Vitest with React Testing Library (existing test infrastructure)  
**Target Platform**: VS Code Desktop (macOS, Windows, Linux)  
**Project Type**: VS Code Extension (single project with webview UI)  
**Performance Goals**: <5s MCP server discovery, <2s action list retrieval, <30s action execution timeout  
**Constraints**: Must use Copilot's MCP configuration, no external MCP client libraries  
**Scale/Scope**: 5-20 MCP servers, 10-50 actions per server, 5 concurrent executions max

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Biome-First Code Quality**: All new code will be linted with `npm run check` before commit  
✅ **Exhaustive Agent Coverage**: MCP action types will be added to hooks triggers/actions following existing patterns  
✅ **UI Accessibility**: Tree view will use proper VS Code accessibility semantics  
✅ **Test-Driven Stability**: All new code paths will have corresponding Vitest unit tests  
✅ **Simplicity & Maintainability**: Following existing hooks architecture patterns, no new complexity added

**No violations** - This feature extends existing hooks infrastructure using established patterns.

## Project Structure

### Documentation (this feature)

```text
specs/005-mcp-hooks-integration/
├── spec.md              # Feature specification
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 - MCP integration research
├── data-model.md        # Phase 1 - Data entities
├── quickstart.md        # Phase 1 - User guide
├── contracts/           # Phase 1 - API contracts
│   └── mcp-service.ts   # MCP server/action interfaces
└── tasks.md             # Phase 2 - Implementation tasks (generated by /speckit.tasks)
```

### Source Code (VS Code Extension - existing structure)

```text
src/
├── features/
│   └── hooks/
│       ├── types.ts                    # [EXTEND] Add MCP action types
│       ├── hook-manager.ts             # [NO CHANGE] Existing hook CRUD
│       ├── hook-executor.ts            # [EXTEND] Add MCP action execution
│       ├── template-utils.ts           # [NO CHANGE] Template expansion
│       ├── trigger-registry.ts         # [NO CHANGE] Event triggers
│       ├── git-utils.ts                # [NO CHANGE] Git operations
│       ├── actions/
│       │   ├── github-action.ts        # [REFERENCE] Existing MCP pattern
│       │   └── mcp-action.ts           # [NEW] MCP action executor
│       └── services/
│           ├── mcp-discovery.ts        # [NEW] MCP server discovery
│           └── mcp-client.ts           # [NEW] MCP action invocation
├── providers/
│   └── hook-view-provider.ts           # [EXTEND] Add MCP tree view UI
└── utils/
    └── copilot-mcp-utils.ts            # [NEW] Copilot MCP config access

webview-ui/
└── src/
    └── features/
        └── hooks-view/
            ├── components/
            │   └── mcp-action-picker.tsx  # [NEW] MCP server/action tree
            └── hooks/
                └── use-mcp-servers.ts     # [NEW] MCP server state management

tests/
├── unit/
│   └── features/
│       └── hooks/
│           ├── actions/
│           │   └── mcp-action.test.ts     # [NEW] MCP executor tests
│           └── services/
│               ├── mcp-discovery.test.ts  # [NEW] Discovery tests
│               └── mcp-client.test.ts     # [NEW] Client tests
└── integration/
    └── mcp-hooks-integration.test.ts      # [NEW] End-to-end tests
```

**Structure Decision**: VS Code Extension (single project). This feature extends the existing hooks module architecture by adding MCP-specific services, action executors, and UI components. The implementation follows established patterns from the GitHub MCP integration (`github-action.ts`) and reuses existing hook infrastructure.

## Complexity Tracking

**No complexity violations** - This feature follows existing architectural patterns and does not introduce new complexity beyond what the constitution allows.

---

## Phase 0: Research & Technology Decisions ✅

**Status**: COMPLETE  
**Output**: [research.md](research.md)

**Key Decisions**:
1. **MCP Discovery**: Use VS Code Extension API to query Copilot capabilities
2. **Parameter Mapping**: Automatic name-based matching (user clarification)
3. **Timeout Control**: 30s default with configurable override
4. **Concurrency**: Pool of 5 concurrent actions with queueing
5. **UI Approach**: Searchable tree view (servers → tools) in webview

**Technology Stack**:
- VS Code Extension API for MCP integration
- Existing hooks infrastructure (types, executor, manager)
- React + shadcn/ui for webview components
- TypeScript with strict typing

---

## Phase 1: Design & Contracts ✅

**Status**: COMPLETE  
**Outputs**:

- [data-model.md](data-model.md) - Entity definitions and relationships
- [contracts/mcp-service.ts](contracts/mcp-service.ts) - Service interfaces
- [quickstart.md](quickstart.md) - User guide and examples

**Artifacts Delivered**:

### Data Model

- 5 new entity types: MCPServer, MCPTool, MCPActionParams, ParameterMapping, JSONSchema
- Extensions to existing Hook types (ActionType, ActionParameters)
- 4 new type guards for validation
- 6 new constants for limits

### Service Contracts

- `IMCPDiscoveryService`: Server/tool discovery with caching
- `IMCPClientService`: Tool execution with parameter validation
- `IMCPParameterResolver`: Parameter mapping resolution
- `IMCPExecutionPool`: Concurrency control
- 6 custom error types for MCP-specific failures

### User Documentation

- Complete quickstart guide with examples
- Common use cases (GitHub issues, Slack notifications)
- Parameter mapping guide
- Troubleshooting section
- Developer testing guide

**Constitution Re-Check**: ✅ PASSED

- All artifacts follow existing code patterns (mirroring github-action.ts)
- No new architectural complexity introduced
- Service interfaces promote testability
- Type guards ensure type safety
- Documentation complete before implementation

---

## Phase 2: Task Generation

**Status**: READY  
**Next Command**: `/speckit.tasks`

Run `/speckit.tasks` to generate the detailed implementation checklist based on this plan.

---

## Implementation Overview

### Components to Create

**Backend Services** (7 files):
1. `src/features/hooks/services/mcp-discovery.ts` - Server/tool discovery
2. `src/features/hooks/services/mcp-client.ts` - Tool execution
3. `src/features/hooks/services/mcp-parameter-resolver.ts` - Parameter mapping
4. `src/features/hooks/services/mcp-execution-pool.ts` - Concurrency control
5. `src/features/hooks/actions/mcp-action.ts` - Action executor
6. `src/utils/copilot-mcp-utils.ts` - Copilot integration helpers
7. `src/features/hooks/types.ts` - [EXTEND] Add MCP types

**UI Components** (2 files):
1. `webview-ui/src/features/hooks-view/components/mcp-action-picker.tsx` - Server/tool tree
2. `webview-ui/src/features/hooks-view/hooks/use-mcp-servers.ts` - State management

**Tests** (6 files):
1. `tests/unit/features/hooks/actions/mcp-action.test.ts`
2. `tests/unit/features/hooks/services/mcp-discovery.test.ts`
3. `tests/unit/features/hooks/services/mcp-client.test.ts`
4. `tests/unit/features/hooks/services/mcp-parameter-resolver.test.ts`
5. `tests/unit/features/hooks/services/mcp-execution-pool.test.ts`
6. `tests/integration/mcp-hooks-integration.test.ts`

### Integration Points

**Extends Existing Code**:
- `src/features/hooks/types.ts` - Add MCP action types and validators
- `src/features/hooks/hook-executor.ts` - Add MCP action execution branch
- `src/providers/hook-view-provider.ts` - Add MCP tree view provider

**Follows Patterns From**:
- `src/features/hooks/actions/github-action.ts` - MCP client provider pattern
- `src/features/hooks/template-utils.ts` - Parameter template expansion
- `src/features/hooks/types.ts` - Type guards and validation

---

## Success Criteria Validation

Mapping spec success criteria to implementation:

| Success Criteria | Implementation Strategy |
|------------------|------------------------|
| SC-001: Select MCP actions <30s | Cache discovery results (5min TTL), searchable tree UI |
| SC-002: Detect 100% of MCP servers | Query Copilot API for all configured servers |
| SC-003: 95% execution reliability | Timeout control, error handling, retry logic |
| SC-004: Graceful unavailability handling | Skip unavailable servers, preserve config, log errors |
| SC-005: Feedback within 2s | Async execution with progress indicators |
| SC-006: Display info within 5s | Cached discovery, background refresh |
| SC-007: Stable with 5 concurrent | Execution pool with semaphore-based queueing |

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| Copilot API changes | High | Abstract MCP access behind service interface |
| MCP server schema variations | Medium | Use JSON Schema validation for flexibility |
| Performance with many servers | Low | Caching (5min TTL), lazy loading in UI |
| Parameter mapping errors | Medium | Validation before execution, detailed error messages |
| Concurrency bottlenecks | Low | Configurable pool size, queueing with timeout |

---

## Timeline Estimate

Based on existing hooks infrastructure and patterns:

- **Phase 0 (Research)**: ✅ Complete (1 day)
- **Phase 1 (Design)**: ✅ Complete (1 day)
- **Phase 2 (Tasks)**: Ready (run `/speckit.tasks`)
- **Phase 3 (Implementation)**: ~5-7 days
  - Services layer: 2 days
  - Action executor: 1 day
  - UI components: 1 day
  - Testing: 1-2 days
  - Integration & polish: 1 day
- **Phase 4 (Review & Deploy)**: 1 day

**Total Estimate**: 9-11 days from task generation to deployment
